<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Premium Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        /* Previous CSS remains the same, adding new styles for admin management */
        
        /* Admin Management Styles */
        .admin-management {
            margin-top: 30px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #00bcd4;
        }
        
        .admin-controls-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .admin-control-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            background: linear-gradient(45deg, #ff9800, #ff5722);
            color: white;
            flex: 1;
            min-width: 200px;
        }
        
        .admin-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 87, 34, 0.3);
        }
        
        .admin-control-btn.secondary {
            background: linear-gradient(45deg, #00bcd4, #0097a7);
        }
        
        .admin-control-btn.danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 3px solid #ff9800;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #ff9800;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #b0bec5;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: #ff5722;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #ff9800;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #ff9800;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #b0bec5;
            font-size: 0.9rem;
        }
        
        /* Logs Table */
        .logs-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }
        
        .log-entry {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-action {
            color: #ff9800;
            font-weight: 600;
        }
        
        .log-time {
            color: #b0bec5;
            font-size: 0.8rem;
        }
        
        /* Admin Level Badges */
        .level-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .level-1 {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }
        
        .level-2 {
            background: rgba(0, 188, 212, 0.2);
            color: #00bcd4;
        }
        
        /* Admin Users List */
        .admin-users-list {
            margin-top: 20px;
        }
        
        .admin-user-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-user-info {
            flex: 1;
        }
        
        .admin-user-email {
            color: #fff;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .admin-user-status {
            font-size: 0.8rem;
            color: #b0bec5;
        }
        
        .admin-user-actions {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Password Login Modal -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-container">
            <div class="login-logo">
                <div class="login-logo-icon">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="login-logo-text">
                    <div class="login-logo-main">EASY PREMIUM</div>
                    <div class="admin-logo-sub">Admin Panel</div>
                </div>
            </div>
            <h2 class="login-title">এডমিন লগইন</h2>
            <p class="login-subtitle">সুরক্ষিত এডমিন প্যানেল, পাসওয়ার্ড দিন</p>
            
            <form id="loginForm">
                <div class="login-input-group">
                    <label for="adminPassword" class="login-label">এডমিন পাসওয়ার্ড</label>
                    <input type="password" id="adminPassword" class="login-input" placeholder="পাসওয়ার্ড দিন..." required>
                </div>
                
                <button type="submit" id="loginBtn" class="login-btn">
                    লগইন করুন
                </button>
                
                <div id="loginError" class="error-message"></div>
            </form>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">পাসওয়ার্ড পরিবর্তন করুন</h3>
                <button class="close-modal" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="currentPassword" class="form-label">বর্তমান পাসওয়ার্ড</label>
                    <input type="password" id="currentPassword" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="newPassword" class="form-label">নতুন পাসওয়ার্ড</label>
                    <input type="password" id="newPassword" class="form-input" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword" class="form-label">নতুন পাসওয়ার্ড নিশ্চিত করুন</label>
                    <input type="password" id="confirmPassword" class="form-input" required minlength="6">
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">পাসওয়ার্ড পরিবর্তন করুন</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">বাতিল করুন</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Admin User Modal -->
    <div id="addAdminModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">নতুন এডমিন যোগ করুন</h3>
                <button class="close-modal" onclick="closeModal('addAdminModal')">&times;</button>
            </div>
            <form id="addAdminForm">
                <div class="form-group">
                    <label for="adminEmail" class="form-label">ইমেইল এড্রেস</label>
                    <input type="email" id="adminEmail" class="form-input" placeholder="admin@example.com" required>
                </div>
                
                <div class="form-group">
                    <label for="adminUserPassword" class="form-label">পাসওয়ার্ড</label>
                    <input type="password" id="adminUserPassword" class="form-input" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirmAdminPassword" class="form-label">পাসওয়ার্ড নিশ্চিত করুন</label>
                    <input type="password" id="confirmAdminPassword" class="form-input" required minlength="6">
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">এডমিন যোগ করুন</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addAdminModal')">বাতিল করুন</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Admin Stats Modal -->
    <div id="statsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">সিস্টেম স্ট্যাটিস্টিক্স</h3>
                <button class="close-modal" onclick="closeModal('statsModal')">&times;</button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="totalPlatforms">0</div>
                    <div class="stat-label">মোট প্ল্যাটফর্ম</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="activePlatforms">0</div>
                    <div class="stat-label">সক্রিয় প্ল্যাটফর্ম</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">মোট অর্ডার</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="pendingOrders">0</div>
                    <div class="stat-label">পেন্ডিং অর্ডার</div>
                </div>
            </div>
            
            <h4 style="margin-top: 30px; color: #00bcd4;">সাম্প্রতিক লগ</h4>
            <div class="logs-container" id="recentLogs">
                <div class="log-entry">
                    <span class="log-action">সিস্টেম লোড হচ্ছে...</span>
                    <span class="log-time" style="float: right;">-</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Panel -->
    <header class="admin-header" id="adminHeader">
        <div class="admin-logo">
            <div class="admin-logo-icon">
                <i class="fas fa-crown"></i>
            </div>
            <div class="admin-logo-text">
                <div class="admin-logo-main">EASY PREMIUM</div>
                <div class="admin-logo-sub">Secure Admin Panel</div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
            <div>
                <h1 class="admin-title">প্ল্যাটফর্ম ম্যানেজমেন্ট</h1>
                <p class="admin-subtitle">সুরক্ষিত এডমিন প্যানেল | আপনার আইডি: <span id="adminUidDisplay">-</span></p>
            </div>
            
            <div class="admin-controls">
                <button id="logoutBtn" class="logout-btn">লগ আউট</button>
            </div>
        </div>
        
        <!-- Admin Management Panel -->
        <div class="admin-management" id="adminManagement" style="display: none;">
            <h3 class="section-title" style="color: #00bcd4;">এডমিন কন্ট্রোলস</h3>
            
            <div class="admin-controls-panel">
                <button class="admin-control-btn" onclick="showModal('changePasswordModal')">
                    <i class="fas fa-key"></i> পাসওয়ার্ড পরিবর্তন
                </button>
                
                <button class="admin-control-btn secondary" onclick="showModal('addAdminModal')" id="addAdminBtn">
                    <i class="fas fa-user-plus"></i> নতুন এডমিন যোগ করুন
                </button>
                
                <button class="admin-control-btn secondary" onclick="showModal('statsModal'); loadStats();">
                    <i class="fas fa-chart-bar"></i> সিস্টেম স্ট্যাটস
                </button>
                
                <button class="admin-control-btn danger" onclick="showAdminLogs()">
                    <i class="fas fa-history"></i> অ্যাকটিভিটি লগ
                </button>
            </div>
            
            <!-- Admin Users List -->
            <div class="admin-users-list" id="adminUsersList" style="display: none;">
                <h4 style="margin-top: 20px; color: #ff9800;">এডমিন ইউজার্স</h4>
                <div id="adminUsersContainer">
                    <!-- Admin users will be loaded here -->
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="admin-container" id="adminContainer">
        <!-- Left Side - Form -->
        <section class="admin-form-section">
            <h2 class="section-title" id="formTitle">নতুন প্ল্যাটফর্ম যোগ করুন</h2>
            
            <form id="platformForm">
                <input type="hidden" id="platformId" value="">
                
                <div class="form-group">
                    <label for="platformName" class="form-label">প্ল্যাটফর্মের নাম *</label>
                    <input type="text" id="platformName" class="form-input" placeholder="যেমন: YouTube Premium" required>
                </div>
                
                <div class="form-group">
                    <label for="platformIcon" class="form-label">প্ল্যাটফর্ম আইকন সিলেক্ট করুন *</label>
                    <select id="platformIcon" class="form-select" required>
                        <option value="">একটি আইকন সিলেক্ট করুন</option>
                        <option value="youtube">YouTube</option>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="tiktok">TikTok</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="telegram">Telegram</option>
                        <option value="freefire">FreeFire</option>
                        <option value="netflix">Netflix</option>
                        <option value="spotify">Spotify</option>
                        <option value="pubg">PUBG</option>
                        <option value="default">অন্যান্য</option>
                    </select>
                    
                    <div class="icon-selection" id="iconSelection">
                        <!-- Icons will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="platformDescription" class="form-label">বর্ণনা *</label>
                    <textarea id="platformDescription" class="form-textarea" placeholder="প্ল্যাটফর্মের সংক্ষিপ্ত বর্ণনা লিখুন..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="platformPrice" class="form-label">দাম *</label>
                    <input type="text" id="platformPrice" class="form-input" placeholder="যেমন: ৳ 299 / মাস" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ফিচারগুলো যোগ করুন</label>
                    <div class="features-container" id="featuresContainer">
                        <!-- Features will be added here dynamically -->
                    </div>
                    <button type="button" id="addFeatureBtn" class="add-feature-btn">নতুন ফিচার যোগ করুন</button>
                </div>
                
                <div class="form-group">
                    <label for="platformCategory" class="form-label">ক্যাটাগরি</label>
                    <input type="text" id="platformCategory" class="form-input" placeholder="যেমন: Social Media, Gaming, Streaming">
                </div>
                
                <div class="form-group">
                    <label for="platformOrder" class="form-label">অর্ডার নম্বর</label>
                    <input type="number" id="platformOrder" class="form-input" placeholder="ছোট সংখ্যা আগে দেখাবে" value="0">
                    <small style="color: #b0bec5; font-size: 0.8rem;">ছোট সংখ্যা আগে দেখাবে (ডিফল্ট: 0)</small>
                </div>
                
                <div class="form-group">
                    <label for="platformStatus" class="form-label">স্ট্যাটাস</label>
                    <select id="platformStatus" class="form-select">
                        <option value="active">সক্রিয়</option>
                        <option value="inactive">নিষ্ক্রিয়</option>
                    </select>
                </div>
                
                <div class="form-buttons">
                    <button type="submit" id="submitBtn" class="btn btn-primary">সেভ করুন</button>
                    <button type="button" id="resetBtn" class="btn btn-secondary">রিসেট করুন</button>
                    <button type="button" id="cancelEditBtn" class="btn btn-danger" style="display: none;">এডিট বাতিল করুন</button>
                </div>
            </form>
        </section>
        
        <!-- Right Side - Platforms List -->
        <section class="admin-list-section">
            <h2 class="section-title list-section-title">প্ল্যাটফর্ম তালিকা</h2>
            <div id="platformsList" class="platforms-list">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>প্ল্যাটফর্ম লোড হচ্ছে...</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBt9t6mcjUtXxX2igAJdseuIIc8pP_QPEw",
            authDomain: "easy-premium.firebaseapp.com",
            databaseURL: "https://easy-premium-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "easy-premium",
            storageBucket: "easy-premium.firebasestorage.app",
            messagingSenderId: "155891252265",
            appId: "1:155891252265:web:77ab41de24231e8e5ef038",
            measurementId: "G-CHL8K8HRPX"
        };

        // Firebase Functions URLs
        const FUNCTIONS_BASE_URL = 'https://us-central1-easy-premium.cloudfunctions.net';
        const ADMIN_LOGIN_URL = `${FUNCTIONS_BASE_URL}/adminLogin`;
        const CHANGE_PASSWORD_URL = `${FUNCTIONS_BASE_URL}/changeAdminPassword`;
        const ADD_ADMIN_URL = `${FUNCTIONS_BASE_URL}/addAdminUser`;
        const GET_LOGS_URL = `${FUNCTIONS_BASE_URL}/getAdminLogs`;

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.log("Firebase already initialized");
        }
        
        const database = firebase.database();
        const auth = firebase.auth();
        
        // DOM Elements
        const loginOverlay = document.getElementById('loginOverlay');
        const loginForm = document.getElementById('loginForm');
        const adminPassword = document.getElementById('adminPassword');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        
        const adminHeader = document.getElementById('adminHeader');
        const adminContainer = document.getElementById('adminContainer');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminUidDisplay = document.getElementById('adminUidDisplay');
        const adminManagement = document.getElementById('adminManagement');
        const addAdminBtn = document.getElementById('addAdminBtn');
        
        const platformForm = document.getElementById('platformForm');
        const platformId = document.getElementById('platformId');
        const platformName = document.getElementById('platformName');
        const platformIcon = document.getElementById('platformIcon');
        const platformDescription = document.getElementById('platformDescription');
        const platformPrice = document.getElementById('platformPrice');
        const platformCategory = document.getElementById('platformCategory');
        const platformOrder = document.getElementById('platformOrder');
        const platformStatus = document.getElementById('platformStatus');
        const iconSelection = document.getElementById('iconSelection');
        const featuresContainer = document.getElementById('featuresContainer');
        const addFeatureBtn = document.getElementById('addFeatureBtn');
        const submitBtn = document.getElementById('submitBtn');
        const resetBtn = document.getElementById('resetBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const formTitle = document.getElementById('formTitle');
        const platformsList = document.getElementById('platformsList');
        
        // Modal forms
        const changePasswordForm = document.getElementById('changePasswordForm');
        const addAdminForm = document.getElementById('addAdminForm');
        
        // Variables
        let platforms = [];
        let selectedIcon = '';
        let isEditing = false;
        let currentEditId = null;
        let isAdminLoggedIn = false;
        let currentAdminUid = null;
        let adminLevel = 0;
        
        // Available icons with names
        const availableIcons = [
            { value: 'youtube', name: 'YouTube', class: 'fab fa-youtube youtube' },
            { value: 'facebook', name: 'Facebook', class: 'fab fa-facebook-f facebook' },
            { value: 'instagram', name: 'Instagram', class: 'fab fa-instagram instagram' },
            { value: 'tiktok', name: 'TikTok', class: 'fab fa-tiktok tiktok' },
            { value: 'whatsapp', name: 'WhatsApp', class: 'fab fa-whatsapp whatsapp' },
            { value: 'telegram', name: 'Telegram', class: 'fab fa-telegram telegram' },
            { value: 'freefire', name: 'FreeFire', class: 'fas fa-fire freefire' },
            { value: 'netflix', name: 'Netflix', class: 'fab fa-netflix netflix' },
            { value: 'spotify', name: 'Spotify', class: 'fab fa-spotify spotify' },
            { value: 'pubg', name: 'PUBG', class: 'fas fa-gamepad pubg' },
            { value: 'default', name: 'অন্যান্য', class: 'fas fa-cube default' }
        ];
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            
            // Login form submission
            loginForm.addEventListener('submit', handleLogin);
            
            // Logout button
            logoutBtn.addEventListener('click', handleLogout);
            
            // Change password form
            changePasswordForm.addEventListener('submit', handleChangePassword);
            
            // Add admin form
            addAdminForm.addEventListener('submit', handleAddAdmin);
            
            // Initialize form if logged in
            if (isAdminLoggedIn) {
                initializeAdminPanel();
            }
        });
        
        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Reset forms
            if (modalId === 'changePasswordModal') {
                changePasswordForm.reset();
            } else if (modalId === 'addAdminModal') {
                addAdminForm.reset();
            }
        }
        
        // Check if user is already logged in
        async function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            const storedUid = localStorage.getItem('adminUid');
            const loginTime = localStorage.getItem('adminLoginTime');
            
            if (isLoggedIn && storedUid && loginTime) {
                const currentTime = new Date().getTime();
                const loginTimestamp = parseInt(loginTime);
                const hoursSinceLogin = (currentTime - loginTimestamp) / (1000 * 60 * 60);
                
                if (hoursSinceLogin < 12) { // 12 hours session
                    try {
                        // Try to sign in with stored UID
                        await auth.signInAnonymously();
                        const user = auth.currentUser;
                        
                        if (user) {
                            // Get user's ID token to check custom claims
                            const idTokenResult = await user.getIdTokenResult();
                            
                            if (idTokenResult.claims.admin) {
                                isAdminLoggedIn = true;
                                currentAdminUid = storedUid;
                                adminLevel = idTokenResult.claims.level || 0;
                                showAdminPanel();
                                return;
                            }
                        }
                    } catch (error) {
                        console.error("Auto-login failed:", error);
                    }
                }
            }
            
            // Clear invalid session
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminUid');
            localStorage.removeItem('adminLoginTime');
            isAdminLoggedIn = false;
            showLoginForm();
        }
        
        // Handle login via Firebase Functions
        async function handleLogin(e) {
            e.preventDefault();
            
            const password = adminPassword.value.trim();
            
            if (!password) {
                showLoginError('পাসওয়ার্ড দিন');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'লগইন হচ্ছে...';
            loginError.textContent = '';
            
            try {
                // Call Firebase Function for login
                const response = await fetch(ADMIN_LOGIN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }
                
                if (data.success && data.token) {
                    // Sign in with custom token
                    await auth.signInWithCustomToken(data.token);
                    
                    // Get user's ID token to verify claims
                    const user = auth.currentUser;
                    const idTokenResult = await user.getIdTokenResult();
                    
                    if (idTokenResult.claims.admin) {
                        isAdminLoggedIn = true;
                        currentAdminUid = data.uid;
                        adminLevel = idTokenResult.claims.level || 0;
                        
                        // Store session
                        localStorage.setItem('adminLoggedIn', 'true');
                        localStorage.setItem('adminUid', currentAdminUid);
                        localStorage.setItem('adminLoginTime', new Date().getTime().toString());
                        
                        // Update UI
                        adminUidDisplay.textContent = currentAdminUid.substring(0, 8) + '...';
                        
                        // Show admin panel
                        setTimeout(() => {
                            showAdminPanel();
                            initializeAdminPanel();
                            loginBtn.disabled = false;
                            loginBtn.textContent = 'লগইন করুন';
                            adminPassword.value = '';
                        }, 1000);
                    } else {
                        throw new Error('Admin claims not found');
                    }
                } else {
                    throw new Error('Invalid response from server');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginError(error.message || 'লগইন ব্যর্থ হয়েছে');
                loginBtn.disabled = false;
                loginBtn.textContent = 'লগইন করুন';
            }
        }
        
        // Handle change password
        async function handleChangePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('পাসওয়ার্ড মিলছে না');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('পাসওয়ার্ড কমপক্ষে ৬ অক্ষরের হতে হবে');
                return;
            }
            
            const submitBtn = changePasswordForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'পরিবর্তন হচ্ছে...';
            
            try {
                const response = await fetch(CHANGE_PASSWORD_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-uid': currentAdminUid
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Password change failed');
                }
                
                if (data.success) {
                    alert('পাসওয়ার্ড সফলভাবে পরিবর্তন হয়েছে');
                    closeModal('changePasswordModal');
                    changePasswordForm.reset();
                } else {
                    throw new Error('Password change failed');
                }
                
            } catch (error) {
                console.error('Password change error:', error);
                alert('পাসওয়ার্ড পরিবর্তন ব্যর্থ: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'পাসওয়ার্ড পরিবর্তন করুন';
            }
        }
        
        // Handle add new admin
        async function handleAddAdmin(e) {
            e.preventDefault();
            
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminUserPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            
            if (password !== confirmPassword) {
                alert('পাসওয়ার্ড মিলছে না');
                return;
            }
            
            if (password.length < 6) {
                alert('পাসওয়ার্ড কমপক্ষে ৬ অক্ষরের হতে হবে');
                return;
            }
            
            const submitBtn = addAdminForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'যোগ করা হচ্ছে...';
            
            try {
                // First, prompt for current admin password
                const adminPassword = prompt('অনুগ্রহ করে আপনার বর্তমান এডমিন পাসওয়ার্ড দিন:');
                
                if (!adminPassword) {
                    throw new Error('পাসওয়ার্ড প্রয়োজন');
                }
                
                const response = await fetch(ADD_ADMIN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-uid': currentAdminUid
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        adminPassword: adminPassword
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Admin creation failed');
                }
                
                if (data.success) {
                    alert('নতুন এডমিন সফলভাবে যোগ হয়েছে');
                    closeModal('addAdminModal');
                    addAdminForm.reset();
                    loadAdminUsers();
                } else {
                    throw new Error('Admin creation failed');
                }
                
            } catch (error) {
                console.error('Add admin error:', error);
                alert('এডমিন যোগ করা ব্যর্থ: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'এডমিন যোগ করুন';
            }
        }
        
        // Handle logout
        async function handleLogout() {
            if (confirm('আপনি কি লগ আউট করতে চান?')) {
                try {
                    await auth.signOut();
                    
                    localStorage.removeItem('adminLoggedIn');
                    localStorage.removeItem('adminUid');
                    localStorage.removeItem('adminLoginTime');
                    
                    isAdminLoggedIn = false;
                    currentAdminUid = null;
                    adminLevel = 0;
                    
                    showLoginForm();
                    
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            }
        }
        
        // Show login form
        function showLoginForm() {
            loginOverlay.style.display = 'flex';
            adminHeader.style.display = 'none';
            adminContainer.style.display = 'none';
            isAdminLoggedIn = false;
        }
        
        // Show admin panel
        function showAdminPanel() {
            loginOverlay.style.display = 'none';
            adminHeader.style.display = 'block';
            adminContainer.style.display = 'flex';
            isAdminLoggedIn = true;
            
            // Show admin management panel for level 1 admins
            if (adminLevel === 1) {
                adminManagement.style.display = 'block';
                addAdminBtn.style.display = 'block';
                loadAdminUsers();
            } else {
                adminManagement.style.display = 'none';
            }
        }
        
        // Show login error
        function showLoginError(message) {
            loginError.textContent = message;
            adminPassword.focus();
            
            // Clear error after 3 seconds
            setTimeout(() => {
                loginError.textContent = '';
            }, 3000);
        }
        
        // Initialize admin panel (after login)
        function initializeAdminPanel() {
            initializeIconSelection();
            initializeFeatures();
            loadPlatformsFromFirebase();
            
            // Form submission
            platformForm.addEventListener('submit', handleFormSubmit);
            
            // Reset form
            resetBtn.addEventListener('click', resetForm);
            
            // Cancel edit
            cancelEditBtn.addEventListener('click', cancelEdit);
            
            // Add feature button
            addFeatureBtn.addEventListener('click', addFeatureInput);
            
            // Icon select change
            platformIcon.addEventListener('change', function() {
                selectedIcon = this.value;
                updateIconSelection();
            });
        }
        
        // Load admin users
        async function loadAdminUsers() {
            if (adminLevel !== 1) return;
            
            try {
                const snapshot = await database.ref('adminUsers').once('value');
                const adminUsers = snapshot.val();
                const container = document.getElementById('adminUsersContainer');
                
                if (!adminUsers) {
                    container.innerHTML = '<p style="color: #b0bec5; text-align: center;">কোন এডমিন ইউজার নেই</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                Object.entries(adminUsers).forEach(([uid, user]) => {
                    const userItem = document.createElement('div');
                    userItem.className = 'admin-user-item';
                    
                    userItem.innerHTML = `
                        <div class="admin-user-info">
                            <div class="admin-user-email">${user.email}</div>
                            <div class="admin-user-status">
                                লেভেল: <span class="level-badge level-${user.level || 2}">${user.level || 2}</span>
                                | স্ট্যাটাস: ${user.status || 'active'}
                                | যোগ: ${new Date(user.createdAt || Date.now()).toLocaleDateString('bn-BD')}
                            </div>
                        </div>
                        <div class="admin-user-actions">
                            <button class="action-btn delete-btn" onclick="deleteAdminUser('${uid}', '${user.email}')">রিমুভ</button>
                        </div>
                    `;
                    
                    container.appendChild(userItem);
                });
                
                document.getElementById('adminUsersList').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading admin users:', error);
            }
        }
        
        // Delete admin user
        async function deleteAdminUser(uid, email) {
            if (!confirm(`আপনি কি নিশ্চিত যে আপনি "${email}" ইউজারকে এডমিন থেকে রিমুভ করতে চান?`)) {
                return;
            }
            
            if (uid === currentAdminUid) {
                alert('আপনি নিজেকে রিমুভ করতে পারবেন না');
                return;
            }
            
            try {
                // Remove from database
                await database.ref(`adminUsers/${uid}`).remove();
                
                // Remove custom claims (requires Firebase Admin SDK - would need another function)
                alert('এডমিন ইউজার রিমুভ করা হয়েছে');
                loadAdminUsers();
                
            } catch (error) {
                console.error('Error deleting admin user:', error);
                alert('এডমিন ইউজার রিমুভ করতে সমস্যা হয়েছে');
            }
        }
        
        // Load system statistics
        async function loadStats() {
            try {
                // Load platforms stats
                const platformsSnapshot = await database.ref('publicData/pricingPlans').once('value');
                const platformsData = platformsSnapshot.val();
                
                let totalPlatforms = 0;
                let activePlatforms = 0;
                
                if (platformsData) {
                    Object.values(platformsData).forEach(platform => {
                        totalPlatforms++;
                        if (platform.status === 'active') {
                            activePlatforms++;
                        }
                    });
                }
                
                document.getElementById('totalPlatforms').textContent = totalPlatforms;
                document.getElementById('activePlatforms').textContent = activePlatforms;
                
                // Load orders stats
                const ordersSnapshot = await database.ref('transactions').once('value');
                const ordersData = ordersSnapshot.val();
                
                let totalOrders = 0;
                let pendingOrders = 0;
                
                if (ordersData) {
                    Object.values(ordersData).forEach(order => {
                        totalOrders++;
                        if (order.status === 'pending') {
                            pendingOrders++;
                        }
                    });
                }
                
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('pendingOrders').textContent = pendingOrders;
                
                // Load recent logs
                await loadRecentLogs();
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Load recent logs
        async function loadRecentLogs() {
            try {
                const response = await fetch(GET_LOGS_URL, {
                    method: 'GET',
                    headers: {
                        'x-admin-uid': currentAdminUid
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.logs) {
                    const logsContainer = document.getElementById('recentLogs');
                    logsContainer.innerHTML = '';
                    
                    data.logs.slice(0, 10).forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        
                        const time = new Date(log.timestamp || Date.now()).toLocaleString('bn-BD');
                        
                        logEntry.innerHTML = `
                            <span class="log-action">${log.action || 'Unknown action'}</span>
                            <span class="log-time" style="float: right;">${time}</span>
                            ${log.email ? `<div style="font-size: 0.8rem; color: #00bcd4;">ইমেইল: ${log.email}</div>` : ''}
                        `;
                        
                        logsContainer.appendChild(logEntry);
                    });
                }
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }
        
        // Show admin logs
        async function showAdminLogs() {
            showModal('statsModal');
            loadStats();
        }
        
        // The rest of the functions remain the same as previous implementation
        // (initializeIconSelection, selectIcon, updateIconSelection, initializeFeatures, 
        // addFeatureInput, getFeatures, setFeatures, loadPlatformsFromFirebase, 
        // displayPlatforms, handleFormSubmit, editPlatform, deletePlatform, 
        // resetForm, cancelEdit, showSuccessMessage)
        
        // Note: The rest of the platform management functions (lines 1000-1500)
        // from the previous implementation should be copied here
        
    </script>
</body>
</html>
