const { RecaptchaEnterpriseServiceClient } = require('@google-cloud/recaptcha-enterprise');

exports.deleteUserAccount = functions.https.onRequest(async (req, res) => {
    const { idToken, recaptchaToken } = req.body;

    // Verify Firebase ID token first
    // ... (আপনার আগের কোড)

    const client = new RecaptchaEnterpriseServiceClient();
    const projectPath = client.projectPath('easy-premium');  // আপনার project ID

    const request = {
        assessment: {
            event: {
                token: recaptchaToken,
                siteKey: '6LcvR2MsAAAAAJQ3aDu6YdjuTALAOpCNfRTqY8RJ',
                expectedAction: 'delete_account'
            }
        },
        parent: projectPath
    };

    const [response] = await client.createAssessment(request);

    if (!response.tokenProperties.valid) {
        return res.status(400).json({ success: false, error: 'Invalid reCAPTCHA token' });
    }

    if (response.riskAnalysis.score < 0.5) {  // আপনার threshold সেট করুন
        return res.status(403).json({ success: false, error: 'Low reCAPTCHA score' });
    }

    // যদি valid → user delete করুন
    // admin.auth().deleteUser(uid)
    // ... ইত্যাদি

    res.json({ success: true });
});
