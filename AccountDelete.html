<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাকাউন্ট এবং ডাটা ডিলিট - EasyPremium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=YOUR_SITE_KEY"></script> <!-- YOUR_SITE_KEY পরিবর্তন করুন -->

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getDatabase, ref, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBt9t6mcjUtXxX2igAJdseuIIc8pP_QPEw",
            authDomain: "easy-premium.firebaseapp.com",
            databaseURL: "https://easy-premium-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "easy-premium",
            storageBucket: "easy-premium.firebasestorage.app",
            messagingSenderId: "155891252265",
            appId: "1:155891252265:web:77ab41de24231e8e5ef038",
            measurementId: "G-CHL8K8HRPX"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').textContent = user.email || 'অজানা';
                document.getElementById('not-logged-in').style.display = 'none';
                document.getElementById('logged-in-content').style.display = 'block';
            } else {
                currentUser = null;
                document.getElementById('not-logged-in').style.display = 'block';
                document.getElementById('logged-in-content').style.display = 'none';
            }
        });

        // ডাটা ডিলিট (আগের মতো)
        async function deleteUserData() {
            if (!currentUser) return alert("লগইন করুন");
            if (!confirm("সকল ডাটা মুছে ফেলবেন? পুনরুদ্ধার যাবে না।")) return;

            try {
                await remove(ref(db, 'users/' + currentUser.uid));
                await remove(ref(db, 'userOrders/' + currentUser.uid));
                alert("ডাটা মুছে ফেলা হয়েছে!");
            } catch (e) {
                alert("সমস্যা: " + e.message);
            }
        }

        // অ্যাকাউন্ট ডিলিট - reCAPTCHA + Cloud Function কল (পাসওয়ার্ড ছাড়া)
        async function deleteAccount() {
            if (!currentUser) return alert("লগইন করুন");

            // reCAPTCHA টোকেন জেনারেট (action: 'delete_account')
            grecaptcha.ready(async () => {
                try {
                    const token = await grecaptcha.execute('YOUR_SITE_KEY', {action: 'delete_account'}); // YOUR_SITE_KEY পরিবর্তন করুন

                    // Cloud Function-এ POST রিকোয়েস্ট (আপনার Cloud Function URL দিন)
                    const response = await fetch('https://asia-southeast1-easy-premium.cloudfunctions.net/deleteUserAccount', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            idToken: await currentUser.getIdToken(), // auth টোকেন
                            recaptchaToken: token
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert("আপনার অ্যাকাউন্ট সফলভাবে ডিলিট করা হয়েছে। ধন্যবাদ!");
                        window.location.href = "index.html";
                    } else {
                        alert("ভেরিফিকেশন ব্যর্থ: " + (data.error || "অজানা সমস্যা"));
                    }
                } catch (e) {
                    alert("সমস্যা: " + e.message);
                }
            });
        }

        window.deleteUserData = deleteUserData;
        window.deleteAccount = deleteAccount;
    </script>

    <!-- আগের স্টাইল একই রাখা হয়েছে, শুধু ছোট করে দিলাম -->
    <style>
        /* ... আগের স্টাইল কপি করুন ... */
        /* নতুন যোগ: reCAPTCHA বক্সের জন্য */
        .recaptcha-note { font-size: 0.9rem; color: #666; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

    <!-- Header একই -->

    <main class="main-container">
        <!-- Hero একই -->

        <div id="not-logged-in"> <!-- একই --> </div>

        <div id="logged-in-content">
            <p class="info-text" style="text-align:center;">লগইন: <span id="user-email">...</span></p>

            <!-- ডাটা ডিলিট সেকশন একই -->

            <!-- অ্যাকাউন্ট ডিলিট সেকশন -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-user-times"></i></div>
                    <h2 class="section-title">সম্পূর্ণ অ্যাকাউন্ট ডিলিট করুন</h2>
                </div>
                <p>অ্যাকাউন্ট এবং সব ডাটা চিরতরে মুছে যাবে।</p>
                <div class="warning-box">
                    <h3>সতর্কতা!</h3>
                    <p>এটি পুনরুদ্ধারযোগ্য নয়।</p>
                </div>
                <p class="recaptcha-note">আপনি রোবট নন তা নিশ্চিত করতে হবে।</p>
                <button onclick="deleteAccount()" class="delete-btn">অ্যাকাউন্ট ডিলিট করুন</button>
            </div>
        </div>
    </main>

</body>
</html>
