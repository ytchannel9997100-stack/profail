<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাকাউন্ট এবং ডাটা ডিলিট - EasyPremium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            deleteUser,
            reauthenticateWithCredential,
            EmailAuthProvider,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            remove
        } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBt9t6mcjUtXxX2igAJdseuIIc8pP_QPEw",
            authDomain: "easy-premium.firebaseapp.com",
            databaseURL: "https://easy-premium-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "easy-premium",
            storageBucket: "easy-premium.firebasestorage.app",
            messagingSenderId: "155891252265",
            appId: "1:155891252265:web:77ab41de24231e8e5ef038",
            measurementId: "G-CHL8K8HRPX"
        };

        // Initialize Firebase
        console.log("Initializing Firebase...");
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            console.log("Auth state changed:", user ? "User logged in" : "No user");
            
            if (user) {
                console.log("User details:", {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName
                });
                
                currentUser = user;
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('user-uid').textContent = user.uid;
                document.getElementById('not-logged-in').style.display = 'none';
                document.getElementById('logged-in-content').style.display = 'block';
                
                // Check session storage
                if (localStorage.getItem('easyPremiumUser')) {
                    console.log("User found in localStorage");
                }
            } else {
                console.log("No user found, checking localStorage...");
                
                // Check if user session exists in localStorage
                const storedUser = localStorage.getItem('easyPremiumUser');
                if (storedUser) {
                    try {
                        const userData = JSON.parse(storedUser);
                        console.log("Found user in localStorage:", userData);
                        
                        // Show message to refresh or login
                        document.getElementById('not-logged-in').innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <h2 style="color: #f59e0b;"><i class="fas fa-exclamation-triangle"></i> সেশন মেয়াদ শেষ</h2>
                                <p>আপনার সেশন মেয়াদ শেষ হয়ে গেছে। পৃষ্ঠাটি রিফ্রেশ করুন বা আবার লগইন করুন।</p>
                                <div style="margin-top: 20px;">
                                    <button onclick="window.location.reload()" style="
                                        background: #3b82f6;
                                        color: white;
                                        border: none;
                                        padding: 10px 20px;
                                        border-radius: 5px;
                                        margin-right: 10px;
                                        cursor: pointer;
                                    ">
                                        <i class="fas fa-redo"></i> রিফ্রেশ করুন
                                    </button>
                                    <a href="login.html" style="
                                        background: #10b981;
                                        color: white;
                                        padding: 10px 20px;
                                        border-radius: 5px;
                                        text-decoration: none;
                                        display: inline-block;
                                    ">
                                        <i class="fas fa-sign-in-alt"></i> লগইন করুন
                                    </a>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error("Error parsing stored user:", e);
                        showLoginMessage();
                    }
                } else {
                    showLoginMessage();
                }
                
                document.getElementById('logged-in-content').style.display = 'none';
                document.getElementById('not-logged-in').style.display = 'block';
            }
        });

        function showLoginMessage() {
            document.getElementById('not-logged-in').innerHTML = `
                <h2><i class="fas fa-user-lock"></i> লগইন প্রয়োজন</h2>
                <p>আপনার অ্যাকাউন্ট বা ডেটা ডিলিট করতে লগইন করুন।</p>
                <a href="login.html" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> লগইন পেজে যান
                </a>
            `;
        }

        // শুধু ডাটা ডিলিট ফাংশন
        async function deleteUserData() {
            if (!currentUser) {
                alert("আপনি লগইন করা নেই। দয়া করে পৃষ্ঠাটি রিফ্রেশ করুন।");
                return;
            }
            
            const confirmed = confirm("আপনার সকল ডাটা মুছে ফেলতে চান?\n\n⚠️ সতর্কতা: এটি পুনরুদ্ধার করা যাবে না!");
            if (!confirmed) return;

            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ডাটা মুছে ফেলা হচ্ছে...';
                btn.disabled = true;

                const userId = currentUser.uid;
                
                // ডাটা মুছুন
                await remove(ref(db, 'users/' + userId));
                await remove(ref(db, 'userOrders/' + userId));
                
                alert("✅ আপনার ডাটা সফলভাবে মুছে ফেলা হয়েছে!");
                
                btn.innerHTML = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error("Error:", error);
                alert("ত্রুটি: " + error.message);
                
                const btn = event.target;
                btn.innerHTML = "ডাটা ডিলিট করুন";
                btn.disabled = false;
            }
        }

        // সম্পূর্ণ অ্যাকাউন্ট ডিলিট ফাংশন
        async function deleteAccount() {
            if (!currentUser) {
                alert("আপনি লগইন করা নেই। দয়া করে পৃষ্ঠাটি রিফ্রেশ করুন।");
                return;
            }

            const confirmed = confirm("সম্পূর্ণ অ্যাকাউন্ট মুছে ফেলতে চান?\n\n⚠️ এটি চিরতরে মুছে যাবে!");
            if (!confirmed) return;

            const password = prompt("নিরাপত্তার জন্য আপনার পাসওয়ার্ড দিন:");
            if (!password) {
                alert("পাসওয়ার্ড প্রয়োজন।");
                return;
            }

            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> অ্যাকাউন্ট মুছে ফেলা হচ্ছে...';
                btn.disabled = true;

                // পাসওয়ার্ড যাচাই
                const credential = EmailAuthProvider.credential(currentUser.email, password);
                await reauthenticateWithCredential(currentUser, credential);

                const userId = currentUser.uid;
                
                // ডাটা মুছুন
                await remove(ref(db, 'users/' + userId));
                await remove(ref(db, 'userOrders/' + userId));
                
                // অ্যাকাউন্ট মুছুন
                await deleteUser(currentUser);
                
                // লগআউট
                await signOut(auth);
                
                // localStorage থেকে মুছুন
                localStorage.removeItem('easyPremiumUser');
                
                alert("✅ আপনার অ্যাকাউন্ট সফলভাবে মুছে ফেলা হয়েছে!");
                window.location.href = "index.html";

            } catch (error) {
                console.error("Error:", error);
                
                let errorMsg = "ত্রুটি: ";
                if (error.code === 'auth/wrong-password') {
                    errorMsg = "❌ ভুল পাসওয়ার্ড";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMsg = "⚠️ সাম্প্রতিক লগইন প্রয়োজন। লগআউট করুন এবং আবার লগইন করুন।";
                } else {
                    errorMsg += error.message;
                }
                
                alert(errorMsg);
                
                const btn = event.target;
                btn.innerHTML = "অ্যাকাউন্ট ডিলিট করুন";
                btn.disabled = false;
            }
        }

        // ফাংশনগুলো গ্লোবাল করুন
        window.deleteUserData = deleteUserData;
        window.deleteAccount = deleteAccount;

        // ডিবাগিং জন্য: লগইন স্ট্যাটাস চেক করুন
        function checkLoginStatus() {
            console.log("Checking login status...");
            console.log("Current user:", currentUser);
            console.log("Auth object:", auth);
            console.log("LocalStorage user:", localStorage.getItem('easyPremiumUser'));
        }

        window.checkLoginStatus = checkLoginStatus;

    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Kalpurush', sans-serif;
        }

        body {
            background: #f8fafc;
            color: #1e293b;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a, #2563eb);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logo span {
            color: #fbbf24;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 6px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .main-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 15px;
        }

        .hero {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .hero h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .warning {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-weight: 600;
        }

        .btn:hover {
            background: #b91c1c;
        }

        #not-logged-in {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #not-logged-in h2 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .login-btn {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            margin-top: 15px;
        }

        .login-btn:hover {
            background: #2563eb;
        }

        .user-info {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .debug-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        }

        .debug-info {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            max-width: 300px;
            font-size: 12px;
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">Easy<span>Premium</span></div>
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> ফিরে যান
        </a>
    </header>

    <main class="main-container">
        <section class="hero">
            <h1>ডাটা এবং অ্যাকাউন্ট ডিলিট</h1>
            <p>আপনার ডেটা গোপনীয়তা আমাদের অগ্রাধিকার। GDPR অনুযায়ী, আপনি এখানে আপনার ডেটা বা সম্পূর্ণ অ্যাকাউন্ট মুছে ফেলতে পারেন।</p>
        </section>

        <div id="not-logged-in">
            <!-- লোড হচ্ছে... -->
        </div>

        <div id="logged-in-content" style="display:none;">
            <div class="user-info">
                <p><i class="fas fa-user"></i> লগইন করা: <strong id="user-email">...</strong></p>
                <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    User ID: <span id="user-uid">...</span>
                </p>
            </div>

            <!-- ডাটা ডিলিট -->
            <div class="card">
                <h2><i class="fas fa-database"></i> শুধু ডাটা ডিলিট</h2>
                <p>অ্যাকাউন্ট থাকবে, কিন্তু সকল অর্ডার এবং ডাটা মুছে যাবে</p>
                <div class="warning">
                    <strong><i class="fas fa-exclamation-triangle"></i> সতর্কতা:</strong> এটি পুনরুদ্ধার করা যাবে না
                </div>
                <button onclick="deleteUserData()" class="btn">
                    ডাটা ডিলিট করুন
                </button>
            </div>

            <!-- অ্যাকাউন্ট ডিলিট -->
            <div class="card">
                <h2><i class="fas fa-user-times"></i> সম্পূর্ণ অ্যাকাউন্ট ডিলিট</h2>
                <p>অ্যাকাউন্ট এবং সকল ডাটা চিরতরে মুছে যাবে</p>
                <div class="warning">
                    <strong><i class="fas fa-radiation-alt"></i> সতর্কতা:</strong> এটি অপরিবর্তনীয়
                </div>
                <button onclick="deleteAccount()" class="btn">
                    অ্যাকাউন্ট ডিলিট করুন
                </button>
                <p style="text-align: center; color: #6b7280; font-size: 12px; margin-top: 10px;">
                    নিরাপত্তার জন্য পাসওয়ার্ড প্রয়োজন হবে
                </p>
            </div>
        </div>
    </main>

    <!-- ডিবাগ বাটন -->
    <button class="debug-btn" onclick="document.getElementById('debug-info').style.display = 
        document.getElementById('debug-info').style.display === 'block' ? 'none' : 'block';
        checkLoginStatus();">
        <i class="fas fa-bug"></i> ডিবাগ
    </button>

    <div class="debug-info" id="debug-info">
        <h4>ডিবাগ তথ্য:</h4>
        <p><strong>ইউজার:</strong> <span id="debug-email">চেকিং...</span></p>
        <p><strong>UID:</strong> <span id="debug-uid">চেকিং...</span></p>
        <p><strong>লগইন স্ট্যাটাস:</strong> <span id="debug-status">চেকিং...</span></p>
        <button onclick="window.location.reload()" style="
            background: #3b82f6;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 10px;
            margin-top: 5px;
        ">
            রিফ্রেশ
        </button>
    </div>

    <footer style="text-align: center; padding: 20px; color: #6b7280; font-size: 14px;">
        <p>© 2024 EasyPremium. সর্বস্বত্ব সংরক্ষিত।</p>
        <p style="margin-top: 5px; font-size: 12px;">
            <i class="fas fa-lock"></i> আপনার ডেটা নিরাপদে আছে
        </p>
    </footer>

    <script>
        // ডিবাগ তথ্য আপডেট
        function updateDebugInfo() {
            const user = JSON.parse(localStorage.getItem('easyPremiumUser') || '{}');
            document.getElementById('debug-email').textContent = user.email || 'কোন ইউজার নেই';
            document.getElementById('debug-uid').textContent = user.uid || 'N/A';
            document.getElementById('debug-status').textContent = user.email ? 'লগইন আছে' : 'লগইন নেই';
        }

        // প্রতি ২ সেকেন্ডে আপডেট
        setInterval(updateDebugInfo, 2000);
        updateDebugInfo();

        // ফায়ারবেজ ইন্সট্যান্স চেক
        console.log("Firebase app initialized:", window.firebaseApp);
    </script>

</body>
</html>
