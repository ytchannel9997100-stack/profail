<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EASY PREMIUM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ®</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            background-color: #0f172a; 
            color: white; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .app-container { 
            max-width: 400px; 
            margin: 0 auto; 
            min-height: 100vh; 
            background: #0f172a;
            position: relative;
            padding-bottom: 70px;
        }
        
        .hidden { display: none !important; }
        
        .header {
            background: #1e293b;
            padding: 12px 16px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .game-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: black;
            font-weight: 900;
        }
        
        .logo {
            font-size: 16px;
            font-weight: 800;
            color: #f59e0b;
            font-style: italic;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .balance-badge {
            background-color: #f59e0b;
            color: black;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        
        .store-icon {
            background-color: #8b5cf6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            border: 2px solid #a78bfa;
        }
        
        .store-icon:hover {
            background-color: #7c3aed;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .wallet-section {
            padding: 20px 16px;
        }
        
        .wallet-title {
            font-size: 22px;
            font-weight: 900;
            color: white;
            margin-bottom: 24px;
            font-style: italic;
            text-transform: uppercase;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .action-btn {
            padding: 18px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        .add-money {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .withdraw {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .history-section {
            padding: 0 16px;
        }
        
        .section-title {
            font-size: 12px;
            color: #94a3b8;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }
        
        .history-card {
            background: #1e293b;
            border-left: 4px solid #f59e0b;
            padding: 16px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .history-type {
            font-size: 12px;
            font-weight: 700;
            color: #94a3b8;
        }
        
        .history-amount {
            font-size: 16px;
            font-weight: 700;
        }
        
        .add-color {
            color: #10b981 !important;
        }
        
        .withdraw-color {
            color: #ef4444 !important;
        }
        
        .history-footer {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #64748b;
        }
        
        .history-status {
            font-weight: 700;
        }
        
        .pending { color: #f59e0b !important; }
        .approved { color: #22c55e !important; }
        .rejected { color: #ef4444 !important; }
        .purchase { color: #ef4444 !important; }
        
        .matches-section {
            padding: 20px 16px;
        }
        
        .matches-title {
            font-size: 22px;
            font-weight: 900;
            color: white;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .matches-subtitle {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 24px;
        }
        
        .game-mode-tabs {
            display: flex;
            background: #1e293b;
            border-radius: 10px;
            padding: 6px;
            margin-bottom: 20px;
            gap: 6px;
        }
        
        .game-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-transform: uppercase;
        }
        
        .game-tab.active {
            background: #f59e0b;
            color: black;
            border-color: #f59e0b;
        }
        
        .match-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 2px solid #334155;
            position: relative;
        }
        
        .match-title {
            font-size: 18px;
            font-weight: 900;
            color: #f59e0b;
            margin-bottom: 8px;
            text-align: center;
            text-transform: uppercase;
        }
        
        .match-time {
            font-size: 12px;
            color: #94a3b8;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .match-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .match-item {
            background: rgba(245, 158, 11, 0.1);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        
        .item-label { font-size: 11px; color: #94a3b8; margin-bottom: 4px; }
        .item-value { font-size: 16px; font-weight: 800; color: #f59e0b; }
        
        .match-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            background: rgba(30, 41, 59, 0.8);
            padding: 12px;
            border-radius: 10px;
        }
        
        .detail-item { text-align: center; }
        .detail-label { font-size: 10px; color: #94a3b8; margin-bottom: 4px; }
        .detail-value { font-size: 13px; font-weight: 700; color: white; }
        
        .players-info {
            font-size: 14px;
            color: #f59e0b;
            text-align: center;
            margin: 12px 0;
            font-weight: 700;
        }
        
        .purchase-status {
            font-size: 12px;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            margin: 12px 0;
            font-weight: 700;
        }
        
        .purchased { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .not-purchased { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .match-actions { display: flex; gap: 12px; margin-top: 16px; }
        
        .match-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            border: none;
            cursor: pointer;
            text-align: center;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .details-btn { background: #0ea5e9; color: white; }
        .purchase-btn { background: #f59e0b; color: black; }
        .purchase-btn:disabled { background: #64748b; cursor: not-allowed; }
        
        .link-btn {
            background: #8b5cf6;
            color: white;
            padding: 14px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            border: none;
            cursor: pointer;
            text-align: center;
            width: 100%;
            margin-top: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .link-btn.show { display: flex; }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            width: 100%;
            max-width: 340px;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header { 
            padding: 20px; 
            text-align: center; 
            color: white; 
            font-weight: 900; 
            font-size: 18px; 
            font-style: italic;
            background: #334155;
        }
        
        .modal-body { padding: 20px; }
        .modal-title { 
            text-align: center; 
            color: #334155; 
            font-weight: 700; 
            font-size: 14px; 
            margin-bottom: 16px; 
        }
        
        .method-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .method-btn { padding: 16px; border-radius: 12px; color: white; font-weight: 700; font-size: 14px; border: none; cursor: pointer; }
        .bkash-btn { background: #d12053; }
        .nagad-btn { background: #f6921e; }
        
        .info-box { 
            background: linear-gradient(135deg, #f8fafc, #f1f5f9); 
            padding: 16px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            border: 1px solid #e2e8f0; 
        }
        
        .info-text { 
            color: #334155 !important; 
            margin-bottom: 8px; 
            line-height: 1.5; 
        }
        
        .copy-number { 
            background: #f59e0b20; 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid #f59e0b40; 
            margin: 12px 0; 
            font-weight: 700; 
            color: #f59e0b !important; 
            text-align: center; 
            font-size: 18px; 
            letter-spacing: 1px; 
        }
        
        .input-field { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 10px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            color: #334155 !important; 
            background-color: #ffffff;
            font-weight: 500; 
            font-size: 14px; 
            outline: none;
        }
        
        .input-field:focus {
            border-color: #f59e0b;
        }
        
        .verify-btn { 
            width: 100%; 
            padding: 14px; 
            background: #f59e0b; 
            color: black; 
            border: none; 
            border-radius: 10px; 
            font-weight: 700; 
            font-size: 14px; 
            cursor: pointer; 
            text-transform: uppercase; 
            margin-top: 8px; 
        }
        
        .cancel-btn { 
            width: 100%; 
            text-align: center; 
            padding: 12px; 
            color: #64748b; 
            font-weight: 600; 
            font-size: 12px; 
            cursor: pointer; 
            margin-top: 8px; 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: #64748b; 
        }
        
        .empty-icon { 
            font-size: 48px; 
            margin-bottom: 16px; 
            opacity: 0.5; 
        }
        
        .loading { 
            display: flex; 
            justify-content: center; 
            padding: 40px; 
        }
        
        .spinner { 
            width: 40px; 
            height: 40px; 
            border: 4px solid rgba(245, 158, 11, 0.2); 
            border-top: 4px solid #f59e0b; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            max-width: 400px; 
            margin: 0 auto; 
            background: #1e293b; 
            border-top: 1px solid #334155; 
            padding: 10px 0; 
            z-index: 100; 
            display: flex; 
            justify-content: space-around; 
        }
        
        .nav-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: #94a3b8; 
            font-size: 11px; 
            font-weight: 600; 
            text-transform: uppercase; 
            cursor: pointer; 
            flex: 1; 
            padding: 8px 0; 
        }
        
        .nav-btn i { 
            font-size: 20px; 
            margin-bottom: 4px; 
        }
        
        .nav-btn.active { 
            color: #f59e0b; 
        }
        
        .page-section { 
            display: none; 
        }
        
        .page-section.active { 
            display: block; 
        }
        
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: #0f172a;
        }
        
        .login-logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
        }
        
        .login-game-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: black;
            font-weight: 900;
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }
        
        .login-logo {
            font-size: 24px;
            font-weight: 800;
            color: #f59e0b;
            font-style: italic;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            line-height: 1.2;
        }
        
        .login-card {
            background: #1e293b;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 350px;
            border: 2px solid #334155;
            text-align: center;
        }
        
        .login-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .login-subtitle {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 30px;
        }
        
        .google-login-btn {
            background: white;
            color: #334155;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            width: 100%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .google-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .google-icon {
            font-size: 20px;
            color: #4285F4;
        }
        
        .user-email-display {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 20px;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            word-break: break-all;
        }
        
        .error-message {
            color: #ef4444;
            background: rgba(239,68,68,0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            display: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #334155;
            font-size: 13px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            color: #334155;
            background: #f9fafb;
        }
        
        .submit-btn {
            background: #f59e0b;
            color: black;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            text-transform: uppercase;
        }
        
        .telegram-link-box {
            background: #0088cc20;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #0088cc40;
        }
        
        .telegram-link {
            color: #0088cc;
            font-weight: 600;
            word-break: break-all;
            font-size: 14px;
        }
        
        .copy-link-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .success-message {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            font-weight: 600;
        }
        
        .hidden-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div class="login-logo-container">
            <div class="login-logo" onclick="window.open('https://easy-premium.com/Info', '_blank')">EASY PREMIUM</div>
        </div>
        <h2 class="login-title">Welcome to Easy Premium</h2>
        <p class="login-subtitle">Join tournaments and win real money</p>
        
        <div id="loadingSection" class="loading" style="display: none;">
            <div class="spinner"></div>
        </div>
        
        <div id="loginSection">
            <button id="googleLoginBtn" class="google-login-btn" onclick="signInWithGoogle()">
                <i class="fab fa-google google-icon"></i>
                Sign in with Google
            </button>
            
            <div class="user-email-display" id="userEmailDisplay" style="display: none;"></div>
            
            <div id="errorMessage" class="error-message"></div>
        </div>
    </div>
</div>

<!-- Main App (Hidden initially) -->
<div class="app-container hidden" id="mainContainer">
    <div class="header">
        <div class="logo-container">
            <div class="logo" onclick="window.open('https://easy-premium.com/Info.html', '_blank')">EASY PREMIUM</div>
        </div>
        <div class="header-right">
            <!-- Store Icon -->
            <div class="store-icon" onclick="window.open('https://easy-premium.com/Products.html', '_blank')" title="Visit Store">
                <i class="fas fa-store"></i>
            </div>
            
            <div class="balance-badge">
                <i class="fas fa-wallet mr-1"></i>
                à§³ <span id="balanceVal">0</span>
            </div>
        </div>
    </div>
    
    <div class="page-section active" id="walletPage">
        <div class="wallet-section">
            <h1 class="wallet-title">MY WALLET</h1>
            <div class="action-buttons">
                <button class="action-btn add-money" onclick="openModal('add')">ADD MONEY</button>
                <button class="action-btn withdraw" onclick="openModal('withdraw')">WITHDRAW</button>
            </div>
            <div class="history-section">
                <div class="section-title">HISTORY</div>
                <div id="historyItems"></div>
            </div>
        </div>
    </div>
    
    <div class="page-section" id="matchesPage">
        <div class="matches-section">
            <h1 class="matches-title">GAME MATCHES</h1>
            <p class="matches-subtitle">Join tournaments and win real money</p>
            <div class="game-mode-tabs">
                <div class="game-tab active" onclick="changeGameMode('solo')">Solo</div>
                <div class="game-tab" onclick="changeGameMode('duo')">Duo</div>
                <div class="game-tab" onclick="changeGameMode('squad')">Squad</div>
                <div class="game-tab" onclick="changeGameMode('clash')">Clash</div>
            </div>
            <div id="matchListContainer"></div>
        </div>
    </div>
</div>

<!-- Bottom Nav (Initially Hidden) -->
<div class="bottom-nav hidden" id="bottomNav">
    <div class="nav-btn active" onclick="switchPage('wallet')">
        <i class="fas fa-wallet"></i>
        <span>WALLET</span>
    </div>
    <div class="nav-btn" onclick="switchPage('matches')">
        <i class="fas fa-trophy"></i>
        <span>MATCHES</span>
    </div>
    <div class="nav-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span>LOGOUT</span>
    </div>
</div>

<!-- Payment Modal -->
<div id="payModal" class="hidden modal-overlay">
    <div class="modal-content">
        <div id="modalHeader" class="modal-header">
            <span id="headerTitle">ADD MONEY</span>
        </div>
        <div class="modal-body">
            <div id="methodStep">
                <div class="modal-title">Select Payment Method</div>
                <div class="method-buttons">
                    <button class="method-btn bkash-btn" onclick="showForm('bkash')">BKASH</button>
                    <button class="method-btn nagad-btn" onclick="showForm('nagad')">NAGAD</button>
                </div>
                <button onclick="closeModal()" class="cancel-btn">CANCEL</button>
            </div>
            <div id="formStep" class="hidden">
                <div id="infoBox" class="info-box">
                    <p id="instr1" class="info-text font-bold"></p>
                    <div id="copyNumberDisplay" class="copy-number"></div>
                    <p id="instr2" class="info-text"></p>
                </div>
                <div>
                    <input type="number" id="inpAmount" class="input-field" placeholder="Enter Amount">
                    <input type="text" id="inpInfo" class="input-field" placeholder="Transaction ID / Number">
                    <button onclick="submitReq()" id="submitBtn" class="verify-btn">VERIFY</button>
                </div>
                <button onclick="goBackToMethod()" class="cancel-btn">BACK</button>
            </div>
        </div>
    </div>
</div>

<!-- Join Match Modal -->
<div id="joinMatchModal" class="hidden modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span id="joinMatchTitle">Join: Match</span>
        </div>
        <div class="modal-body">
            <div id="joinMatchStep1">
                <div class="modal-title">Enter Your Game Details</div>
                <div class="form-group">
                    <label class="form-label">Game ID Name</label>
                    <input type="text" id="gameIdName" class="form-input" placeholder="Enter your game ID name">
                </div>
                <div class="form-group">
                    <label class="form-label">Game UID</label>
                    <input type="text" id="gameUid" class="form-input" placeholder="Enter your game UID">
                </div>
                <div class="form-group">
                    <label class="form-label">Telegram Username</label>
                    <input type="text" id="telegramUsername" class="form-input" placeholder="@username">
                </div>
                
                <!-- BALANCE CHECK TEXT REMOVED -->
                <div class="info-box" id="balanceCheckBox" style="display: none;">
                    <p class="info-text" id="balanceCheckText"></p>
                </div>
                
                <button onclick="checkBalanceAndSubmit()" class="submit-btn" id="joinSubmitBtn">JOIN MATCH</button>
                <button onclick="closeJoinModal()" class="cancel-btn">CANCEL</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCSoTqqSC_NqigWrHwE4Q8IUvWRP9TrxG8",
        authDomain: "top-up-4db01.firebaseapp.com",
        projectId: "top-up-4db01",
        databaseURL: "https://top-up-4db01-default-rtdb.asia-southeast1.firebasedatabase.app",
        storageBucket: "top-up-4db01.appspot.com",
        appId: "1:264548197473:web:abcd1234efgh5678"
    };

    // Initialize Firebase
    let db, auth;
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        db = firebase.database();
        auth = firebase.auth();
    } catch (error) {
        console.error("Firebase initialization error:", error);
        showError("Firebase configuration error. Please contact admin.");
    }
    
    let userId = null, userBalance = 0;
    let currentUser = null;
    let historyListener = null;
    let balanceListener = null;

    // Display transactions - FIXED VERSION
    function displayTransactions(transactions) {
        const div = document.getElementById('historyItems');
        let html = '';
        
        if (transactions.length === 0) {
            html = '<div class="empty-state"><div class="empty-text">No transaction history</div></div>';
            div.innerHTML = html;
            return;
        }
        
        transactions.forEach(d => {
            const type = d.type || '';
            const amount = parseFloat(d.amount) || 0;
            const status = d.status || 'pending';
            const method = d.method || '';
            const info = d.info || '';
            
            let isPositive = false;
            let displayType = type.toUpperCase();
            const typeLower = type.toLowerCase();
            const infoLower = info.toLowerCase();
            
            // TOURNAMENT ENTRY - Always RED with PURCHASE status
            if (typeLower.includes('tournament_entry') || 
                typeLower.includes('entry_fee') ||
                infoLower.includes('tournament') && infoLower.includes('entry') ||
                infoLower.includes('entry fee')) {
                isPositive = false;
                displayType = 'TOURNAMENT_ENTRY';
            }
            // ADD MONEY - GREEN
            else if (typeLower.includes('add')) {
                isPositive = true;
            }
            // WITHDRAW - RED
            else if (typeLower.includes('withdraw')) {
                isPositive = false;
            }
            // PRIZE - GREEN
            else if (typeLower.includes('prize')) {
                isPositive = true;
            }
            // Default based on amount
            else {
                isPositive = amount > 0;
            }
            
            const amountColor = isPositive ? 'add-color' : 'withdraw-color';
            const sign = isPositive ? '+' : '-';
            
            // Status handling
            let statusClass = '';
            let displayStatus = status.toUpperCase();
            
            // TOURNAMENT ENTRY shows PURCHASE in RED
            if (displayType === 'TOURNAMENT_ENTRY') {
                displayStatus = 'PURCHASE';
                statusClass = 'purchase'; // RED color
            }
            // Regular statuses
            else if (status.toLowerCase() === 'approved') {
                statusClass = 'approved'; // GREEN
            } else if (status.toLowerCase() === 'pending') {
                statusClass = 'pending'; // YELLOW
            } else {
                statusClass = 'rejected'; // RED
            }
            
            const displayAmount = Math.abs(amount);
            
            // Format date
            let displayDate = d.date || '';
            if (d.timestamp) {
                try {
                    displayDate = new Date(d.timestamp).toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                } catch (e) {}
            }
            
            const methodText = method ? ' - ' + method.toUpperCase() : '';
            
            html += `
                <div class="history-card">
                    <div class="history-header">
                        <span class="history-type">${displayType}${methodText}</span>
                        <span class="history-amount ${amountColor}">${sign}à§³${displayAmount}</span>
                    </div>
                    <div class="history-footer">
                        <span>${displayDate}</span>
                        <span class="history-status ${statusClass}">${displayStatus}</span>
                    </div>
                </div>`;
        });
        
        div.innerHTML = html;
    }

    // Auth State Observer
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            userId = user.uid;
            showMainApp();
            initializeUserData();
        } else {
            showLoginScreen();
        }
    });

    // Show Error
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    // Show Login Screen
    function showLoginScreen() {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainContainer').classList.add('hidden');
        document.getElementById('bottomNav').classList.add('hidden');
        document.getElementById('loadingSection').style.display = 'none';
    }

    // Show Main App
    function showMainApp() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainContainer').classList.remove('hidden');
        document.getElementById('bottomNav').classList.remove('hidden');
    }

    // Google Sign In
    function signInWithGoogle() {
        document.getElementById('loadingSection').style.display = 'flex';
        
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        
        auth.signInWithPopup(provider)
            .then((result) => {
                const user = result.user;
                initializeUserInDatabase(user.uid, user.email);
            })
            .catch((error) => {
                console.error('Login error:', error);
                document.getElementById('loadingSection').style.display = 'none';
                showError('Login failed. Please try again.');
            });
    }

    // Initialize User in Database
    function initializeUserInDatabase(uid, email) {
        const userRef = db.ref('users/' + uid);
        userRef.once('value').then((snapshot) => {
            if (!snapshot.exists()) {
                userRef.set({
                    email: email,
                    balance: 0,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
            } else {
                userRef.update({
                    lastLogin: new Date().toISOString()
                });
            }
        });
    }

    // Initialize User Data
    function initializeUserData() {
        if (!userId) return;
        
        // Listen for balance changes
        balanceListener = db.ref('users/' + userId + '/balance').on('value', s => {
            userBalance = parseInt(s.val()) || 0;
            document.getElementById('balanceVal').textContent = userBalance;
        });
        
        // Load transaction history
        loadTransactionHistory();
    }

    // Load Transaction History
    function loadTransactionHistory() {
        if (!userId) return;
        
        if (historyListener) {
            historyListener();
        }
        
        historyListener = db.ref('users/' + userId + '/history').on('value', snapshot => {
            let transactions = [];
            
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const data = child.val();
                    transactions.push({
                        type: data.type || '',
                        method: data.method || '',
                        amount: data.amount || 0,
                        status: data.status || 'pending',
                        date: data.date || '',
                        info: data.info || '',
                        timestamp: data.timestamp || Date.now()
                    });
                });
                
                transactions.sort((a, b) => b.timestamp - a.timestamp);
            }
            
            displayTransactions(transactions);
        });
    }

    // Switch Page
    function switchPage(page) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
        
        if (page === 'wallet') {
            document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
            document.getElementById('walletPage').classList.add('active');
        } else {
            document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
            document.getElementById('matchesPage').classList.add('active');
        }
    }

    // Change Game Mode
    function changeGameMode(mode) {
        document.querySelectorAll('.game-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
    }

    // Open Tournament Join Modal
    function openJoinMatchFormDirectly() {
        if (!userId) {
            alert('Please login first');
            return;
        }
        
        // Hide balance check text as requested
        document.getElementById('balanceCheckBox').style.display = 'none';
        
        document.getElementById('joinMatchModal').classList.remove('hidden');
        document.getElementById('gameIdName').value = '';
        document.getElementById('gameUid').value = '';
        document.getElementById('telegramUsername').value = '';
    }

    // Join Tournament
    function checkBalanceAndSubmit() {
        const gameIdName = document.getElementById('gameIdName').value.trim();
        const gameUid = document.getElementById('gameUid').value.trim();
        const telegramUsername = document.getElementById('telegramUsername').value.trim();
        
        if (!gameIdName || !gameUid || !telegramUsername) {
            alert('Please fill in all fields!');
            return;
        }
        
        if (!/^@/.test(telegramUsername)) {
            alert('Telegram username must start with @');
            return;
        }
        
        const entryFee = 10; // Example entry fee
        
        if (userBalance < entryFee) {
            alert(`Insufficient balance! Entry fee is à§³${entryFee}\nYour balance: à§³${userBalance}\nPlease add money first.`);
            return;
        }
        
        // Deduct balance
        const newBalance = userBalance - entryFee;
        db.ref('users/' + userId + '/balance').set(newBalance)
            .then(() => {
                userBalance = newBalance;
                document.getElementById('balanceVal').textContent = userBalance;
                
                // Record tournament entry transaction
                const purchaseTransaction = {
                    type: 'TOURNAMENT_ENTRY',
                    method: 'BALANCE_DEDUCTION',
                    amount: entryFee,
                    status: 'PURCHASE',
                    date: new Date().toLocaleString(),
                    info: 'Tournament entry fee',
                    timestamp: Date.now()
                };
                
                return db.ref('users/' + userId + '/history').push(purchaseTransaction);
            })
            .then(() => {
                document.getElementById('joinMatchModal').classList.add('hidden');
                alert(`Successfully joined tournament!\n\nà§³${entryFee} has been deducted from your balance.`);
            })
            .catch(error => {
                console.error('Error joining match:', error);
                alert('Error joining match. Please try again.');
            });
    }

    function closeJoinModal() {
        document.getElementById('joinMatchModal').classList.add('hidden');
    }

    // Modal Functions
    function openModal(mode) {
        if (!userId) {
            alert('Please login first');
            return;
        }
        
        currentMode = mode;
        document.getElementById('payModal').classList.remove('hidden');
        document.getElementById('methodStep').classList.remove('hidden');
        document.getElementById('formStep').classList.add('hidden');
        document.getElementById('headerTitle').textContent = mode === 'add' ? 'ADD MONEY' : 'WITHDRAW';
        document.getElementById('modalHeader').style.background = "#334155";
    }

    function showForm(method) {
        currentMethod = method;
        document.getElementById('methodStep').classList.add('hidden');
        document.getElementById('formStep').classList.remove('hidden');
        const color = method === 'bkash' ? '#d12053' : '#f6921e';
        document.getElementById('modalHeader').style.background = color;
        document.getElementById('submitBtn').style.background = color;
        
        if (currentMode === 'add') {
            document.getElementById('instr1').innerHTML = "Copy Number:";
            document.getElementById('copyNumberDisplay').innerHTML = "017XXXXXXXX";
            document.getElementById('instr2').innerHTML = "Send money and enter TrxID";
        } else {
            document.getElementById('instr1').innerHTML = "Your Balance";
            document.getElementById('copyNumberDisplay').innerHTML = "à§³" + userBalance;
            document.getElementById('instr2').innerHTML = "Enter withdrawal amount and your number";
            
            document.getElementById('inpAmount').value = '';
            document.getElementById('inpInfo').value = '';
        }
    }

    function goBackToMethod() {
        document.getElementById('formStep').classList.add('hidden');
        document.getElementById('methodStep').classList.remove('hidden');
    }

    function submitReq() {
        if (!userId) {
            alert('Please login first');
            return;
        }
        
        const amount = parseInt(document.getElementById('inpAmount').value);
        const info = document.getElementById('inpInfo').value.trim();
        
        if (!amount || !info) {
            alert('Fill all fields!');
            return;
        }
        
        if (currentMode === 'withdraw') {
            if (amount > userBalance) {
                alert('Insufficient balance');
                return;
            }
            
            if (amount < 1) {
                alert('Amount must be at least à§³1');
                return;
            }
        } else {
            if (amount < 10) {
                alert('Minimum deposit amount is à§³10');
                return;
            }
        }
        
        const transaction = {
            userId, 
            amount, 
            info, 
            method: currentMethod, 
            type: currentMode, 
            status: 'pending', 
            date: new Date().toLocaleString(),
            userEmail: currentUser?.email || 'Unknown',
            timestamp: Date.now()
        };
        
        db.ref('users/' + userId + '/history').push(transaction);
        
        db.ref('admin/requests').push(transaction).then(() => {
            alert('Request submitted successfully!');
            closeModal();
            
            if (currentMode === 'withdraw') {
                const newBalance = userBalance - amount;
                db.ref('users/' + userId + '/balance').set(newBalance);
                userBalance = newBalance;
                document.getElementById('balanceVal').textContent = userBalance;
            }
        });
    }

    function closeModal() { 
        document.getElementById('payModal').classList.add('hidden'); 
        document.getElementById('inpAmount').value = '';
        document.getElementById('inpInfo').value = '';
    }
    
    function logout() { 
        if (confirm('Logout?')) {
            auth.signOut();
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // Check if already logged in
        setTimeout(() => {
            const currentUser = auth.currentUser;
            if (currentUser) {
                showMainApp();
                initializeUserData();
            }
        }, 1000);
    });

</script>
</body>
</html>
